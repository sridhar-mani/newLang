name: Publish to npm

on:
    push:
        tags:
            - "v*"

jobs:
    publish:
        name: Publish Packages
        runs-on: ubuntu-latest

        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: "npm"
                  registry-url: "https://registry.npmjs.org"

            - name: Install dependencies
              run: npm ci

            - name: Get Version
              run: npm version ${GITHUB_REF#refs/tags/v} --no-git-tag-version --workspaces

            - name: Update Version
              run: npm version "$VERSION" --no-git-tag-version --workspaces

            - name: Build all packages
              run: npm run build

            # Publish @shader3d/core
            - name: Publish @shader3d/core
              if: ${{ !inputs.dry-run }}
              run: |
                  cd packages/core
                  npm publish --access public --provenance --tag ${{ inputs.tag || 'latest' }}

            # Publish @shader3d/runtime
            - name: Publish @shader3d/runtime
              if: ${{ !inputs.dry-run }}
              run: |
                  cd packages/runtime
                  npm publish --access public --provenance --tag ${{ inputs.tag || 'latest' }}

            # Publish @shader3d/vite-plugin
            - name: Publish @shader3d/vite-plugin
              if: ${{ !inputs.dry-run }}
              run: |
                  cd packages/vite-plugin
                  npm publish --access public --provenance --tag ${{ inputs.tag || 'latest' }}

            # Publish @shader3d/ladder
            - name: Publish @shader3d/ladder
              if: ${{ !inputs.dry-run }}
              run: |
                  cd packages/ladder
                  npm publish --access public --provenance --tag ${{ inputs.tag || 'latest' }}

            - name: Dry run summary
              if: ${{ inputs.dry-run }}
              run: |
                  echo "DRY RUN - No packages were published"
                  echo "Would have published:"
                  echo "  - @shader3d/core"
                  echo "  - @shader3d/runtime"
                  echo "  - @shader3d/vite-plugin"
                  echo "  - @shader3d/ladder"
                  echo "Tag: ${{ inputs.tag || 'latest' }}"
